# main.tf

# Define provider (in this case, AWS)
provider "aws" {
  region = "us-east-1"
}

# Create a security group for the web server
resource "aws_security_group" "web_sg" {
  name        = "web_sg"
  description = "Security group for web server"
  
  ingress {
    from_port   = 80
    to_port     = 80
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }
  
  ingress {
    from_port   = 443
    to_port     = 443
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }
  
  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }
}

# Create an RDS database instance
resource "aws_db_instance" "database" {
  allocated_storage    = 20
  storage_type         = "gp2"
  engine               = "mysql"
  engine_version       = "5.7"
  instance_class       = "db.t2.micro"
  name                 = "mydatabase"
  username             = "admin"
  password             = "password"
  publicly_accessible  = true
  vpc_security_group_ids = [aws_security_group.web_sg.id]
}

# Create an EC2 instance
resource "aws_instance" "web_server" {
  ami           = "ami-0c55b159cbfafe1f0"
  instance_type = "t2.micro"
  security_groups = [aws_security_group.web_sg.name]
  tags = {
    Name = "WebServerInstance"
  }
  
  user_data = <<-EOF
              #!/bin/bash
              sudo yum update -y
              sudo yum install docker -y
              sudo service docker start
              
              # Create a simple HTML file
              echo "<html><body><h1>Hello, World!</h1></body></html>" > index.html
              
              # Create a Dockerfile for the web application
              cat <<EOT >> Dockerfile
              FROM nginx:alpine
              COPY index.html /usr/share/nginx/html/index.html
              EOT
              
              # Build and run the Docker container
              sudo docker build -t my-web-app .
              sudo docker run -d -p 80:80 my-web-app
              
              # Install certbot for Let's Encrypt
              sudo yum install certbot python3-certbot-nginx -y
              
              # Obtain SSL certificate from Let's Encrypt
              sudo certbot certonly --nginx --agree-tos --email your.email@example.com -d yourdomain.com
              
              # Restart Nginx to apply SSL changes
              sudo service nginx restart
              EOF
}

# GitHub Actions Workflow for CI/CD
resource "github_actions_workflow" "terraform_workflow" {
  name     = "Terraform CI/CD"
  on       = "push"
  resolves = ["deploy"]

  # CI/CD Pipeline Steps
  workflow_dispatch {
    inputs = {
      environment = "production"
    }
  }

  action "deploy" {
    uses    = "actions/checkout@v2"
    runs    = "./deploy.sh"
    secrets = ["AWS_ACCESS_KEY_ID", "AWS_SECRET_ACCESS_KEY"]
  }
}

